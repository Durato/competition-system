<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Redefinir Senha - Technovação</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: https://via.placeholder.com http: https:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' http: https:;">
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .reset-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: var(--bg);
    }
    .reset-box {
      background: var(--surface);
      padding: 40px;
      border-radius: 8px;
      border: 1px solid var(--border);
      max-width: 400px;
      width: 100%;
    }
    .reset-box h2 {
      margin-bottom: 10px;
      color: var(--text);
    }
    .reset-box p {
      color: #aaa;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    .reset-box input {
      width: 100%;
      margin-bottom: 15px;
    }
    .reset-box button {
      width: 100%;
    }
    #resetMessage {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 4px;
      font-size: 0.9rem;
      display: none;
    }
    #resetMessage.error {
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.3);
      display: block;
    }
    #resetMessage.success {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
      display: block;
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: var(--primary);
      text-decoration: none;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

<div class="reset-container">
  <div class="reset-box">
    <h2>Redefinir Senha</h2>
    <p>Digite sua nova senha abaixo.</p>

    <div id="resetMessage"></div>

    <form id="resetForm" onsubmit="handleResetPassword(event)">
      <input type="password" id="newPassword" placeholder="Nova senha" required minlength="8" />
      <input type="password" id="confirmNewPassword" placeholder="Confirme a nova senha" required minlength="8" />
      <button type="submit">Redefinir Senha</button>
    </form>

    <a href="index.html" class="back-link">Voltar para o Login</a>
  </div>
</div>

<script src="config.js"></script>
<script src="validators.js"></script>
<script>
const API = Config.API_URL;

// Pega o token da URL
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

if (!token) {
  showMessage("Token inválido ou ausente. Solicite um novo link de recuperação.", "error");
  document.getElementById("resetForm").style.display = "none";
}

function showMessage(message, type) {
  const msgEl = document.getElementById("resetMessage");
  msgEl.textContent = message;
  msgEl.className = type;
}

async function handleResetPassword(e) {
  e.preventDefault();

  const newPassword = document.getElementById("newPassword").value;
  const confirmNewPassword = document.getElementById("confirmNewPassword").value;
  const btn = e.target.querySelector('button');
  const originalText = btn.innerText;

  // Validação da senha
  if (!Validators.password(newPassword)) {
    showMessage("Senha fraca: Mínimo 8 caracteres, com letras e números.", "error");
    return;
  }

  // Verifica se as senhas coincidem
  if (newPassword !== confirmNewPassword) {
    showMessage("As senhas não correspondem.", "error");
    return;
  }

  btn.disabled = true;
  btn.innerText = "Redefinindo...";

  try {
    const res = await fetch(API + "/auth/reset-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, newPassword })
    });

    const data = await res.json();

    if (res.ok) {
      showMessage("Senha redefinida com sucesso! Redirecionando...", "success");
      document.getElementById("resetForm").style.display = "none";

      // Redireciona para a página de login após 3 segundos
      setTimeout(() => {
        window.location.href = "index.html";
      }, 3000);
    } else {
      showMessage(data.error || "Erro ao redefinir senha", "error");
      btn.disabled = false;
      btn.innerText = originalText;
    }
  } catch (error) {
    showMessage("Erro de conexão com o servidor", "error");
    btn.disabled = false;
    btn.innerText = originalText;
  }
}
</script>

</body>
</html>
